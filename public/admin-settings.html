<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Settings - Shreemata</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/admin.css">
    <style>
        .settings-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .settings-section {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border-left: 4px solid #667eea;
        }
        
        .settings-section h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 24px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .setting-group {
            margin-bottom: 25px;
        }
        
        .setting-group h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 18px;
        }
        
        .setting-item {
            display: flex;
            flex-direction: column;
            margin-bottom: 20px;
        }
        
        .setting-item label {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .setting-item input, .setting-item select {
            padding: 12px 16px;
            border: 2px solid #e8ecf4;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .setting-item input:focus, .setting-item select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .help-text {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
            font-style: italic;
        }
        
        .preview-box {
            background: linear-gradient(135deg, #f8f9ff 0%, #e8f2ff 100%);
            border: 2px solid #667eea;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }
        
        .preview-box strong {
            color: #667eea;
        }
        
        .save-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
        }
        
        .save-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }
        
        .stat-card h3 {
            margin: 0 0 10px 0;
            font-size: 14px;
            opacity: 0.9;
        }
        
        .stat-card .value {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .stat-card .label {
            font-size: 12px;
            opacity: 0.8;
        }
        
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background-color: #667eea;
        }
        
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        
        .process-all-btn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-left: 15px;
        }
        
        .process-all-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4);
        }
        
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }
        
        .success-message {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            border-left: 4px solid #28a745;
        }
        
        .error-message {
            background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            border-left: 4px solid #dc3545;
        }
    </style>
</head>
<body>
    <!-- Navigation will be injected by admin-navigation.js -->

    <div class="settings-container">
        <h1 style="text-align: center; color: #2c3e50; margin-bottom: 30px;">
            üéõÔ∏è Admin Settings - Priority Points System
        </h1>
        
        <!-- System Statistics -->
        <div class="settings-section">
            <h2>üìä System Statistics</h2>
            <div class="stats-grid" id="statsGrid">
                <!-- Stats will be loaded here -->
            </div>
        </div>
        
        <!-- Virtual Tree Settings -->
        <div class="settings-section">
            <h2>üå≥ Virtual Tree Settings (Priority 1)</h2>
            
            <div class="setting-group">
                <div class="setting-item">
                    <label>Enable Virtual Trees:</label>
                    <label class="toggle-switch">
                        <input type="checkbox" id="virtualTreeEnabled" checked>
                        <span class="slider"></span>
                    </label>
                    <span class="help-text">Enable/disable virtual tree creation system</span>
                </div>
                
                <div class="setting-item">
                    <label>Points per Virtual Tree:</label>
                    <input type="number" id="pointsPerVirtualTree" value="100" min="10" max="10000">
                    <span class="help-text">How many points needed to create one virtual tree</span>
                </div>
                
                <div class="setting-item">
                    <label>Maximum Virtual Trees per User:</label>
                    <input type="number" id="maxVirtualTreesPerUser" value="5" min="1" max="100">
                    <span class="help-text">Maximum virtual trees one user can have</span>
                </div>
                
                <div class="setting-item">
                    <label>Auto-Create Virtual Trees:</label>
                    <label class="toggle-switch">
                        <input type="checkbox" id="autoCreateEnabled" checked>
                        <span class="slider"></span>
                    </label>
                    <span class="help-text">Automatically create virtual trees when user earns points</span>
                </div>
            </div>
        </div>
        
        <!-- Cash Conversion Settings -->
        <div class="settings-section">
            <h2>üí∞ Cash Conversion Settings (Priority 2)</h2>
            
            <div class="setting-group">
                <div class="setting-item">
                    <label>Enable Cash Conversion:</label>
                    <label class="toggle-switch">
                        <input type="checkbox" id="cashConversionEnabled" checked>
                        <span class="slider"></span>
                    </label>
                    <span class="help-text">Enable/disable automatic points to cash conversion</span>
                </div>
                
                <div class="setting-item">
                    <label>Points per Conversion:</label>
                    <input type="number" id="pointsPerConversion" value="50" min="1" max="10000">
                    <span class="help-text">Points needed for each cash conversion</span>
                </div>
                
                <div class="setting-item">
                    <label>Cash Amount per Conversion (‚Çπ):</label>
                    <input type="number" id="cashPerConversion" value="25" min="0.1" max="1000" step="0.1">
                    <span class="help-text">Cash amount given per conversion</span>
                </div>
                
                <div class="preview-box" id="conversionPreview">
                    <strong>Conversion Rate:</strong> <span id="conversionRate">50 points = ‚Çπ25 (1 point = ‚Çπ0.5)</span>
                </div>
            </div>
        </div>
        
        <!-- Points Earning Settings -->
        <div class="settings-section">
            <h2>üìà Points Earning Settings</h2>
            
            <div class="setting-group">
                <div class="setting-item">
                    <label>Points per Rupee Spent:</label>
                    <input type="number" id="pointsPerRupeeSpent" value="1" min="0.1" max="10" step="0.1">
                    <span class="help-text">How many points user gets per ‚Çπ1 spent</span>
                </div>
                
                <div class="setting-item">
                    <label>First Purchase Bonus Points:</label>
                    <input type="number" id="bonusPointsOnFirstPurchase" value="50" min="0" max="1000">
                    <span class="help-text">Bonus points for first purchase</span>
                </div>
                
                <div class="setting-item">
                    <label>Referral Bonus Points:</label>
                    <input type="number" id="bonusPointsOnReferral" value="100" min="0" max="1000">
                    <span class="help-text">Bonus points when someone uses your referral code</span>
                </div>
            </div>
        </div>
        
        <!-- System Example -->
        <div class="settings-section">
            <h2>üìã System Example</h2>
            <div class="preview-box" id="systemExample">
                <strong>Example: User with 460 points, 2 virtual trees</strong><br>
                <div id="exampleCalculation">
                    <!-- Example will be calculated here -->
                </div>
            </div>
        </div>
        
        <!-- Action Buttons -->
        <div class="settings-section">
            <button class="save-btn" onclick="saveSettings()">üíæ Save All Settings</button>
            <button class="process-all-btn" onclick="processAllUsers()">üîÑ Apply to All Users</button>
            
            <div id="messageContainer"></div>
        </div>
    </div>

    <!-- Load admin navigation -->
    <script src="js/admin-navigation.js"></script>
    <script src="js/config.js"></script>
    
    <script>
        let currentSettings = {};
        
        // Load settings on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadSettings();
            loadStats();
            
            // Add event listeners for real-time preview
            document.getElementById('pointsPerConversion').addEventListener('input', updateConversionPreview);
            document.getElementById('cashPerConversion').addEventListener('input', updateConversionPreview);
            document.getElementById('pointsPerVirtualTree').addEventListener('input', updateSystemExample);
            document.getElementById('maxVirtualTreesPerUser').addEventListener('input', updateSystemExample);
        });
        
        async function loadSettings() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_URL}/admin/settings`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Failed to load settings');
                }
                
                const data = await response.json();
                currentSettings = data.settings;
                
                // Populate form fields
                populateForm(currentSettings);
                updateConversionPreview();
                updateSystemExample();
                
            } catch (error) {
                console.error('Error loading settings:', error);
                showMessage('Error loading settings: ' + error.message, 'error');
            }
        }
        
        async function loadStats() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_URL}/admin/settings/stats`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Failed to load stats');
                }
                
                const data = await response.json();
                displayStats(data.stats);
                
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }
        
        function populateForm(settings) {
            // Virtual Tree Settings
            document.getElementById('virtualTreeEnabled').checked = settings.virtualTreeSettings.enabled;
            document.getElementById('pointsPerVirtualTree').value = settings.virtualTreeSettings.pointsPerVirtualTree;
            document.getElementById('maxVirtualTreesPerUser').value = settings.virtualTreeSettings.maxVirtualTreesPerUser;
            document.getElementById('autoCreateEnabled').checked = settings.virtualTreeSettings.autoCreateEnabled;
            
            // Cash Conversion Settings
            document.getElementById('cashConversionEnabled').checked = settings.cashConversionSettings.enabled;
            document.getElementById('pointsPerConversion').value = settings.cashConversionSettings.pointsPerConversion;
            document.getElementById('cashPerConversion').value = settings.cashConversionSettings.cashPerConversion;
            
            // Points Earning Settings
            document.getElementById('pointsPerRupeeSpent').value = settings.pointsEarningSettings.pointsPerRupeeSpent;
            document.getElementById('bonusPointsOnFirstPurchase').value = settings.pointsEarningSettings.bonusPointsOnFirstPurchase;
            document.getElementById('bonusPointsOnReferral').value = settings.pointsEarningSettings.bonusPointsOnReferral;
        }
        
        function displayStats(stats) {
            const statsGrid = document.getElementById('statsGrid');
            statsGrid.innerHTML = `
                <div class="stat-card">
                    <h3>Total Users</h3>
                    <div class="value">${stats.users.total}</div>
                    <div class="label">Real users</div>
                </div>
                <div class="stat-card">
                    <h3>Virtual Trees</h3>
                    <div class="value">${stats.users.virtual}</div>
                    <div class="label">Virtual users</div>
                </div>
                <div class="stat-card">
                    <h3>Users with Points</h3>
                    <div class="value">${stats.users.withPoints}</div>
                    <div class="label">Have points balance</div>
                </div>
                <div class="stat-card">
                    <h3>Max Virtual Reached</h3>
                    <div class="value">${stats.users.atMaxVirtual}</div>
                    <div class="label">At maximum limit</div>
                </div>
                <div class="stat-card">
                    <h3>Total Points</h3>
                    <div class="value">${stats.points.totalInSystem.toLocaleString()}</div>
                    <div class="label">In system</div>
                </div>
                <div class="stat-card">
                    <h3>Total Cash</h3>
                    <div class="value">‚Çπ${stats.points.totalCashInSystem.toLocaleString()}</div>
                    <div class="label">In wallets</div>
                </div>
            `;
        }
        
        function updateConversionPreview() {
            const pointsPerConversion = parseFloat(document.getElementById('pointsPerConversion').value) || 50;
            const cashPerConversion = parseFloat(document.getElementById('cashPerConversion').value) || 25;
            const rate = (cashPerConversion / pointsPerConversion).toFixed(2);
            
            document.getElementById('conversionRate').textContent = 
                `${pointsPerConversion} points = ‚Çπ${cashPerConversion} (1 point = ‚Çπ${rate})`;
        }
        
        function updateSystemExample() {
            const pointsPerVirtual = parseInt(document.getElementById('pointsPerVirtualTree').value) || 100;
            const maxVirtuals = parseInt(document.getElementById('maxVirtualTreesPerUser').value) || 5;
            const pointsPerConversion = parseInt(document.getElementById('pointsPerConversion').value) || 50;
            const cashPerConversion = parseInt(document.getElementById('cashPerConversion').value) || 25;
            
            // Example: User with 460 points, 2 virtual trees
            const userPoints = 460;
            const currentVirtuals = 2;
            
            const possibleNewVirtuals = Math.min(
                Math.floor(userPoints / pointsPerVirtual),
                maxVirtuals - currentVirtuals
            );
            
            const pointsUsedForVirtuals = possibleNewVirtuals * pointsPerVirtual;
            const remainingPoints = userPoints - pointsUsedForVirtuals;
            const cashConversions = Math.floor(remainingPoints / pointsPerConversion);
            const cashAmount = cashConversions * cashPerConversion;
            const finalPoints = remainingPoints - (cashConversions * pointsPerConversion);
            
            document.getElementById('exampleCalculation').innerHTML = `
                1. Create ${possibleNewVirtuals} virtual trees (${pointsUsedForVirtuals} points) ‚Üí Total: ${currentVirtuals + possibleNewVirtuals}/${maxVirtuals} trees<br>
                2. Convert remaining ${remainingPoints} points ‚Üí ${cashConversions} conversions ‚Üí ‚Çπ${cashAmount} cash<br>
                3. <strong>Final:</strong> ${currentVirtuals + possibleNewVirtuals} virtual trees + ‚Çπ${cashAmount} cash + ${finalPoints} points left
            `;
        }
        
        async function saveSettings() {
            try {
                const saveBtn = document.querySelector('.save-btn');
                saveBtn.classList.add('loading');
                saveBtn.textContent = 'Saving...';
                
                const settings = {
                    virtualTreeSettings: {
                        enabled: document.getElementById('virtualTreeEnabled').checked,
                        pointsPerVirtualTree: parseInt(document.getElementById('pointsPerVirtualTree').value),
                        maxVirtualTreesPerUser: parseInt(document.getElementById('maxVirtualTreesPerUser').value),
                        autoCreateEnabled: document.getElementById('autoCreateEnabled').checked
                    },
                    cashConversionSettings: {
                        enabled: document.getElementById('cashConversionEnabled').checked,
                        pointsPerConversion: parseInt(document.getElementById('pointsPerConversion').value),
                        cashPerConversion: parseFloat(document.getElementById('cashPerConversion').value)
                    },
                    pointsEarningSettings: {
                        pointsPerRupeeSpent: parseFloat(document.getElementById('pointsPerRupeeSpent').value),
                        bonusPointsOnFirstPurchase: parseInt(document.getElementById('bonusPointsOnFirstPurchase').value),
                        bonusPointsOnReferral: parseInt(document.getElementById('bonusPointsOnReferral').value)
                    }
                };
                
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_URL}/admin/settings`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(settings)
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to save settings');
                }
                
                const data = await response.json();
                showMessage('Settings saved successfully!', 'success');
                
                // Reload stats
                loadStats();
                
            } catch (error) {
                console.error('Error saving settings:', error);
                showMessage('Error saving settings: ' + error.message, 'error');
            } finally {
                const saveBtn = document.querySelector('.save-btn');
                saveBtn.classList.remove('loading');
                saveBtn.textContent = 'üíæ Save All Settings';
            }
        }
        
        async function processAllUsers() {
            if (!confirm('This will process all users with the new settings. This may take a while. Continue?')) {
                return;
            }
            
            try {
                const processBtn = document.querySelector('.process-all-btn');
                processBtn.classList.add('loading');
                processBtn.textContent = 'Processing...';
                
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_URL}/admin/settings/process-all-users`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Failed to process users');
                }
                
                const data = await response.json();
                showMessage(
                    `Successfully processed ${data.summary.usersProcessed} users! ` +
                    `Created ${data.summary.totalVirtualTreesCreated} virtual trees, ` +
                    `Converted ‚Çπ${data.summary.totalCashConverted} to cash.`, 
                    'success'
                );
                
                // Reload stats
                loadStats();
                
            } catch (error) {
                console.error('Error processing users:', error);
                showMessage('Error processing users: ' + error.message, 'error');
            } finally {
                const processBtn = document.querySelector('.process-all-btn');
                processBtn.classList.remove('loading');
                processBtn.textContent = 'üîÑ Apply to All Users';
            }
        }
        
        function showMessage(message, type) {
            const container = document.getElementById('messageContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = type === 'success' ? 'success-message' : 'error-message';
            messageDiv.textContent = message;
            
            container.innerHTML = '';
            container.appendChild(messageDiv);
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                messageDiv.remove();
            }, 5000);
        }
    </script>
</body>
</html>