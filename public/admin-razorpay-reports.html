<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Razorpay Payment Reports - Admin</title>
    <link rel="stylesheet" href="css/styles.css">
    <style>
        body {
            background: #f5f5f5;
            margin: 0;
            padding: 0;
        }
        
        nav { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            padding: 15px 0; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
            position: fixed; 
            top: 0; 
            left: 0; 
            right: 0; 
            z-index: 100;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .main-container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-top: 120px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 15px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.2);
            transition: all 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }
        
        .stat-card.success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }
        
        .stat-card.warning {
            background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
        }
        
        .stat-card.danger {
            background: linear-gradient(135deg, #dc3545 0%, #e83e8c 100%);
        }
        
        .stat-icon {
            font-size: 32px;
            opacity: 0.9;
        }
        
        .stat-content {
            flex: 1;
        }
        
        .stat-number {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 14px;
            opacity: 0.9;
            font-weight: 500;
        }
        
        .filters-container {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 25px;
            border: 1px solid #e9ecef;
        }
        
        .filter-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr auto;
            gap: 15px;
            align-items: center;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .filter-label {
            font-size: 14px;
            font-weight: 600;
            color: #333;
        }
        
        .filter-input {
            padding: 10px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .filter-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
        }
        
        .payments-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-top: 20px;
            font-size: 12px; /* Smaller font for more columns */
        }
        
        .payments-table thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .payments-table th,
        .payments-table td {
            padding: 10px 8px; /* Reduced padding for more columns */
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
            vertical-align: top;
        }
        
        .payments-table th {
            font-weight: 600;
            font-size: 12px;
            white-space: nowrap;
        }
        
        .payments-table td {
            font-size: 11px;
            word-break: break-word;
        }
        
        .payments-table tbody tr:hover {
            background: #f9f9f9;
        }
        
        /* Specific column widths */
        .payments-table th:nth-child(1), /* Payment ID */
        .payments-table td:nth-child(1) {
            width: 12%;
        }
        
        .payments-table th:nth-child(2), /* Order ID */
        .payments-table td:nth-child(2) {
            width: 10%;
        }
        
        .payments-table th:nth-child(3), /* Amount */
        .payments-table td:nth-child(3) {
            width: 8%;
        }
        
        .payments-table th:nth-child(4), /* Status */
        .payments-table td:nth-child(4) {
            width: 8%;
        }
        
        .payments-table th:nth-child(5), /* Method */
        .payments-table td:nth-child(5) {
            width: 8%;
        }
        
        .payments-table th:nth-child(6), /* User Name */
        .payments-table td:nth-child(6) {
            width: 12%;
        }
        
        .payments-table th:nth-child(7), /* User Email */
        .payments-table td:nth-child(7) {
            width: 15%;
        }
        
        .payments-table th:nth-child(8), /* Contact */
        .payments-table td:nth-child(8) {
            width: 10%;
        }
        
        .payments-table th:nth-child(9), /* Created At */
        .payments-table td:nth-child(9) {
            width: 8%;
        }
        
        .payments-table th:nth-child(10), /* Captured At */
        .payments-table td:nth-child(10) {
            width: 9%;
        }
        
        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .status-captured {
            background: #d4edda;
            color: #155724;
        }
        
        .status-failed {
            background: #f8d7da;
            color: #721c24;
        }
        
        .status-refunded {
            background: #fff3cd;
            color: #856404;
        }
        
        .method-badge {
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 500;
            background: #e9ecef;
            color: #495057;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #667eea;
            font-size: 16px;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
            font-size: 16px;
        }
        
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
        }
        
        .pagination button {
            padding: 8px 12px;
            border: 1px solid #ddd;
            background: white;
            cursor: pointer;
            border-radius: 4px;
        }
        
        .pagination button:hover {
            background: #f8f9fa;
        }
        
        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        @media (max-width: 768px) {
            .main-container {
                padding: 15px;
                margin-top: 100px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .filter-row {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .payments-table {
                font-size: 12px;
            }
            
            .payments-table th,
            .payments-table td {
                padding: 8px 10px;
            }
        }
        
        /* Period Preset Button Styles */
        .period-preset-btn:hover {
            background: rgba(255,255,255,0.3) !important;
            border-color: rgba(255,255,255,0.5) !important;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        
        .period-preset-btn.active {
            background: rgba(255,255,255,0.4) !important;
            border-color: rgba(255,255,255,0.6) !important;
            font-weight: 600 !important;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body>
    <!-- Include admin navigation -->
    <nav>
        <div class="container">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <img src="/images/logo.png" alt="Logo" style="width: 40px; height: 40px; border-radius: 50%;">
                    <h1 style="margin: 0; color: white; font-size: 20px;">Razorpay Reports</h1>
                </div>
                <div style="color: white; font-size: 14px;">
                    <span id="userName">Hello, Admin</span>
                </div>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="main-container">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                <div>
                    <h1 style="margin: 0 0 5px 0;">üí≥ Razorpay Payment Reports</h1>
                    <p style="color: #666; margin: 0;">Real-time payment data from Razorpay dashboard</p>
                </div>
                <div>
                    <button id="testBtn" class="btn btn-primary" style="margin-right: 10px;">
                        üîß Test Connection
                    </button>
                    <button id="exportBtn" class="btn btn-success">
                        üìä Export CSV
                    </button>
                </div>
            </div>

            <!-- Time Period Indicator with Quick Presets -->
            <div id="timePeriodIndicator" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 12px; margin-bottom: 25px; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.2);">
                <!-- Current Period Display -->
                <div style="display: flex; justify-content: center; align-items: center; gap: 15px; flex-wrap: wrap; margin-bottom: 15px;">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span style="font-size: 24px;">üìÖ</span>
                        <div>
                            <div style="font-size: 18px; font-weight: 700; margin-bottom: 2px;">Data Period</div>
                            <div id="currentDateRange" style="font-size: 14px; opacity: 0.9;">Loading...</div>
                        </div>
                    </div>
                    <div style="width: 2px; height: 40px; background: rgba(255,255,255,0.3); border-radius: 1px;"></div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span style="font-size: 24px;">üîÑ</span>
                        <div>
                            <div style="font-size: 18px; font-weight: 700; margin-bottom: 2px;">Last Updated</div>
                            <div id="lastUpdated" style="font-size: 14px; opacity: 0.9;">Just now</div>
                        </div>
                    </div>
                    <div style="width: 2px; height: 40px; background: rgba(255,255,255,0.3); border-radius: 1px;"></div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span style="font-size: 24px;">‚ö°</span>
                        <div>
                            <div style="font-size: 18px; font-weight: 700; margin-bottom: 2px;">Data Sync</div>
                            <div style="font-size: 14px; opacity: 0.9;">Payments & Settlements use same period</div>
                        </div>
                    </div>
                </div>
                
                <!-- Quick Period Presets -->
                <div style="border-top: 1px solid rgba(255,255,255,0.2); padding-top: 15px;">
                    <div style="text-align: center; margin-bottom: 10px;">
                        <span style="font-size: 14px; font-weight: 600; opacity: 0.9;">‚ö° Quick Select:</span>
                    </div>
                    <div style="display: flex; justify-content: center; gap: 8px; flex-wrap: wrap;">
                        <button class="period-preset-btn" data-period="today" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 6px 12px; border-radius: 20px; font-size: 12px; cursor: pointer; transition: all 0.3s ease;">
                            üìÖ Today
                        </button>
                        <button class="period-preset-btn" data-period="yesterday" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 6px 12px; border-radius: 20px; font-size: 12px; cursor: pointer; transition: all 0.3s ease;">
                            üìÜ Yesterday
                        </button>
                        <button class="period-preset-btn" data-period="last7days" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 6px 12px; border-radius: 20px; font-size: 12px; cursor: pointer; transition: all 0.3s ease;">
                            üìä Last 7 Days
                        </button>
                        <button class="period-preset-btn" data-period="thismonth" style="background: rgba(255,255,255,0.4); border: 1px solid rgba(255,255,255,0.5); color: white; padding: 6px 12px; border-radius: 20px; font-size: 12px; cursor: pointer; transition: all 0.3s ease; font-weight: 600;">
                            üìà This Month
                        </button>
                        <button class="period-preset-btn" data-period="lastmonth" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 6px 12px; border-radius: 20px; font-size: 12px; cursor: pointer; transition: all 0.3s ease;">
                            üìâ Last Month
                        </button>
                        <button class="period-preset-btn" data-period="last30days" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 6px 12px; border-radius: 20px; font-size: 12px; cursor: pointer; transition: all 0.3s ease;">
                            üìã Last 30 Days
                        </button>
                        <button class="period-preset-btn" data-period="last90days" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 6px 12px; border-radius: 20px; font-size: 12px; cursor: pointer; transition: all 0.3s ease;">
                            üìä Last 90 Days
                        </button>
                        <button class="period-preset-btn" data-period="thisyear" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 6px 12px; border-radius: 20px; font-size: 12px; cursor: pointer; transition: all 0.3s ease;">
                            üóìÔ∏è This Year
                        </button>
                    </div>
                </div>
            </div>

            <!-- Summary Statistics -->
            <div class="stats-grid" id="summaryStats">
                <div class="stat-card">
                    <div class="stat-icon">üí∞</div>
                    <div class="stat-content">
                        <div class="stat-number" id="totalAmount">‚Çπ0</div>
                        <div class="stat-label">Total Payments<br><small style="opacity: 0.8;">For selected period</small></div>
                    </div>
                </div>
                <div class="stat-card success">
                    <div class="stat-icon">‚úÖ</div>
                    <div class="stat-content">
                        <div class="stat-number" id="capturedAmount">‚Çπ0</div>
                        <div class="stat-label">Captured Payments<br><small style="opacity: 0.8;">For selected period</small></div>
                    </div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);">
                    <div class="stat-icon">üè¶</div>
                    <div class="stat-content">
                        <div class="stat-number" id="settledAmount">‚Çπ0</div>
                        <div class="stat-label">Settled to Bank<br><small style="opacity: 0.8;">For selected period</small></div>
                    </div>
                </div>
                <div class="stat-card danger">
                    <div class="stat-icon">‚ùå</div>
                    <div class="stat-content">
                        <div class="stat-number" id="failedAmount">‚Çπ0</div>
                        <div class="stat-label">Failed Payments<br><small style="opacity: 0.8;">For selected period</small></div>
                    </div>
                </div>
                <div class="stat-card warning">
                    <div class="stat-icon">üîÑ</div>
                    <div class="stat-content">
                        <div class="stat-number" id="refundedAmount">‚Çπ0</div>
                        <div class="stat-label">Refunded Amount<br><small style="opacity: 0.8;">For selected period</small></div>
                    </div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #6c757d 0%, #495057 100%);">
                    <div class="stat-icon">üí∏</div>
                    <div class="stat-content">
                        <div class="stat-number" id="feesAmount">‚Çπ0</div>
                        <div class="stat-label">Razorpay Fees<br><small style="opacity: 0.8;">For selected period</small></div>
                    </div>
                </div>
            </div>

            <!-- Refund Summary Cards -->
            <div class="stats-grid" style="margin-top: 20px;">
                <div class="stat-card danger">
                    <div class="stat-icon">üí∏</div>
                    <div class="stat-content">
                        <div class="stat-number" id="totalRefundAmount">‚Çπ0</div>
                        <div class="stat-label">Total Refunds (ALL TIME)</div>
                    </div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);">
                    <div class="stat-icon">‚úÖ</div>
                    <div class="stat-content">
                        <div class="stat-number" id="processedRefundAmount">‚Çπ0</div>
                        <div class="stat-label">Processed Refunds</div>
                    </div>
                </div>
                <div class="stat-card warning">
                    <div class="stat-icon">‚è≥</div>
                    <div class="stat-content">
                        <div class="stat-number" id="pendingRefundAmount">‚Çπ0</div>
                        <div class="stat-label">Pending Refunds</div>
                    </div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #6c757d 0%, #495057 100%);">
                    <div class="stat-icon">‚ùå</div>
                    <div class="stat-content">
                        <div class="stat-number" id="failedRefundAmount">‚Çπ0</div>
                        <div class="stat-label">Failed Refunds</div>
                    </div>
                </div>
            </div>

            <!-- Settlement Details Section -->
            <div class="filters-container" style="margin-top: 20px;">
                <h3 style="margin: 0 0 15px 0; color: #333; display: flex; align-items: center; gap: 10px;">
                    üè¶ Settlement Breakdown
                    <span style="background: #e8f5e9; color: #155724; padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 500;">Same Period as Payments</span>
                    <button id="refreshSettlementsBtn" class="btn btn-primary" style="padding: 6px 12px; font-size: 12px;">
                        üîÑ Refresh
                    </button>
                    <button id="fetchAllSettlementsBtn" class="btn btn-success" style="padding: 6px 12px; font-size: 12px;">
                        üìä Get ALL Settlements
                    </button>
                    <button id="viewSettlementHistoryBtn" class="btn" style="padding: 6px 12px; font-size: 12px; background: linear-gradient(135deg, #17a2b8 0%, #138496 100%); color: white;">
                        üìã View Settlement History
                    </button>
                    <button id="fetchAllRefundsBtn" class="btn" style="padding: 6px 12px; font-size: 12px; background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); color: white;">
                        üí∏ Get ALL Refunds
                    </button>
                </h3>
                <div id="settlementDetails" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <div style="background: #e8f5e9; padding: 15px; border-radius: 8px; border-left: 4px solid #28a745;">
                        <div style="font-size: 14px; color: #155724; font-weight: 600;">Net Settlement</div>
                        <div style="font-size: 20px; font-weight: 700; color: #155724;" id="netSettlement">‚Çπ0</div>
                        <div style="font-size: 12px; color: #155724; opacity: 0.8;">Amount credited to bank</div>
                    </div>
                    <div style="background: #fff3cd; padding: 15px; border-radius: 8px; border-left: 4px solid #ffc107;">
                        <div style="font-size: 14px; color: #856404; font-weight: 600;">Total Fees</div>
                        <div style="font-size: 20px; font-weight: 700; color: #856404;" id="totalFees">‚Çπ0</div>
                        <div style="font-size: 12px; color: #856404; opacity: 0.8;">Razorpay charges + tax</div>
                    </div>
                    <div style="background: #d1ecf1; padding: 15px; border-radius: 8px; border-left: 4px solid #17a2b8;">
                        <div style="font-size: 14px; color: #0c5460; font-weight: 600;">Settlement Rate</div>
                        <div style="font-size: 20px; font-weight: 700; color: #0c5460;" id="settlementRate">0%</div>
                        <div style="font-size: 12px; color: #0c5460; opacity: 0.8;">Net amount / Gross amount</div>
                    </div>
                    <div style="background: #f8d7da; padding: 15px; border-radius: 8px; border-left: 4px solid #dc3545;">
                        <div style="font-size: 14px; color: #721c24; font-weight: 600;">Fee Percentage</div>
                        <div style="font-size: 20px; font-weight: 700; color: #721c24;" id="feePercentage">0%</div>
                        <div style="font-size: 12px; color: #721c24; opacity: 0.8;">Total fees / Gross amount</div>
                    </div>
                </div>
            </div>

            <!-- Settlement History Section -->
            <div class="filters-container" style="margin-top: 20px; display: none;" id="settlementHistorySection">
                <h3 style="margin: 0 0 15px 0; color: #333; display: flex; align-items: center; gap: 10px;">
                    üè¶ Settlement History
                    <button id="hideSettlementHistoryBtn" class="btn" style="padding: 6px 12px; font-size: 12px; background: #6c757d; color: white;">
                        ‚ùå Hide
                    </button>
                    <button id="exportSettlementsBtn" class="btn btn-success" style="padding: 6px 12px; font-size: 12px;">
                        üìä Export CSV
                    </button>
                </h3>
                
                <div id="settlementHistoryTable" style="overflow-x: auto;">
                    <table class="payments-table">
                        <thead>
                            <tr>
                                <th>Settlement Date</th>
                                <th>Settlement ID</th>
                                <th>Amount Settled</th>
                                <th>Fees Deducted</th>
                                <th>Tax</th>
                                <th>Net Amount</th>
                                <th>UTR Number</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="settlementHistoryBody">
                            <tr>
                                <td colspan="8" style="text-align: center; padding: 40px; color: #666;">
                                    Click "üìä Get ALL Settlements" to load settlement history
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <div id="settlementPagination" class="pagination" style="display: none;">
                    <button id="prevSettlementBtn" onclick="loadPreviousSettlements()">‚Üê Previous</button>
                    <span id="settlementPageInfo">Page 1</span>
                    <button id="nextSettlementBtn" onclick="loadNextSettlements()">Next ‚Üí</button>
                </div>
            </div>

            <!-- Filters -->
            <div class="filters-container">
                <div class="filter-row">
                    <div class="filter-group">
                        <label class="filter-label">From Date</label>
                        <input type="date" id="fromDate" class="filter-input">
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">To Date</label>
                        <input type="date" id="toDate" class="filter-input">
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Status</label>
                        <select id="statusFilter" class="filter-input">
                            <option value="all">All Status</option>
                            <option value="captured" selected>Captured</option>
                            <option value="failed">Failed</option>
                            <option value="refunded">Refunded</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Records</label>
                        <select id="countFilter" class="filter-input">
                            <option value="25">25</option>
                            <option value="50" selected>50</option>
                            <option value="100">100</option>
                        </select>
                    </div>
                    <div style="align-self: end;">
                        <button id="loadBtn" class="btn btn-primary">
                            üîç Load Data
                        </button>
                    </div>
                </div>
            </div>

            <!-- Loading State -->
            <div id="loadingState" class="loading" style="display: none;">
                Loading payment data from Razorpay...
            </div>

            <!-- Payments Table -->
            <div id="paymentsContainer" style="display: none;">
                <div style="overflow-x: auto; margin-top: 20px;">
                    <table class="payments-table">
                        <thead>
                            <tr>
                                <th>Payment ID</th>
                                <th>Order ID</th>
                                <th>Amount</th>
                                <th>Status</th>
                                <th>Method</th>
                                <th>User Name</th>
                                <th>User Email</th>
                                <th>Contact</th>
                                <th>Created At</th>
                                <th>Captured At</th>
                            </tr>
                        </thead>
                        <tbody id="paymentsTableBody">
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                <div class="pagination" id="pagination">
                    <button id="prevBtn" onclick="loadPreviousPage()">‚Üê Previous</button>
                    <span id="pageInfo">Page 1</span>
                    <button id="nextBtn" onclick="loadNextPage()">Next ‚Üí</button>
                </div>
            </div>

            <!-- Empty State -->
            <div id="emptyState" class="empty-state" style="display: none;">
                <p>No payment data found for the selected criteria.</p>
            </div>
        </div>
    </div>

    <script src="js/config.js"></script>
    <script>
        const API = window.API_URL || '/api';
        let currentPage = 0;
        let currentFilters = {};
        let hasMoreData = false;

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            // Set default dates (current month)
            const now = new Date();
            const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
            const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0);
            
            document.getElementById('fromDate').value = firstDay.toISOString().split('T')[0];
            document.getElementById('toDate').value = lastDay.toISOString().split('T')[0];
            
            // Update time period indicator
            updateTimePeriodIndicator();
            updateActivePresetButton('thismonth'); // Default to "This Month"
            
            // Load initial data
            loadPaymentSummary();
            loadPaymentData();
            
            // Set up event listeners
            document.getElementById('loadBtn').addEventListener('click', function() {
                updateTimePeriodIndicator();
                loadPaymentData();
            });
            document.getElementById('exportBtn').addEventListener('click', exportPaymentData);
            document.getElementById('testBtn').addEventListener('click', testConnection);
            document.getElementById('refreshSettlementsBtn').addEventListener('click', function() {
                updateTimePeriodIndicator();
                loadPaymentSummary();
            });
            document.getElementById('fetchAllSettlementsBtn').addEventListener('click', fetchAllSettlements);
            document.getElementById('fetchAllRefundsBtn').addEventListener('click', fetchAllRefunds);
            document.getElementById('viewSettlementHistoryBtn').addEventListener('click', viewSettlementHistory);
            document.getElementById('hideSettlementHistoryBtn').addEventListener('click', hideSettlementHistory);
            document.getElementById('exportSettlementsBtn').addEventListener('click', exportSettlementHistory);
            
            // Update time period when dates change
            document.getElementById('fromDate').addEventListener('change', function() {
                updateTimePeriodIndicator();
                updateActivePresetButton(null); // Clear active preset when manually changing dates
            });
            document.getElementById('toDate').addEventListener('change', function() {
                updateTimePeriodIndicator();
                updateActivePresetButton(null); // Clear active preset when manually changing dates
            });
            
            // Set up period preset buttons
            document.querySelectorAll('.period-preset-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const period = this.getAttribute('data-period');
                    setPeriodPreset(period);
                    updateActivePresetButton(period);
                });
            });
        });

        function setPeriodPreset(period) {
            const now = new Date();
            let fromDate, toDate;
            
            switch(period) {
                case 'today':
                    fromDate = new Date(now);
                    toDate = new Date(now);
                    break;
                    
                case 'yesterday':
                    fromDate = new Date(now.getTime() - 24 * 60 * 60 * 1000);
                    toDate = new Date(now.getTime() - 24 * 60 * 60 * 1000);
                    break;
                    
                case 'last7days':
                    fromDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                    toDate = new Date(now);
                    break;
                    
                case 'thismonth':
                    fromDate = new Date(now.getFullYear(), now.getMonth(), 1);
                    toDate = new Date(now.getFullYear(), now.getMonth() + 1, 0);
                    break;
                    
                case 'lastmonth':
                    fromDate = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                    toDate = new Date(now.getFullYear(), now.getMonth(), 0);
                    break;
                    
                case 'last30days':
                    fromDate = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                    toDate = new Date(now);
                    break;
                    
                case 'last90days':
                    fromDate = new Date(now.getTime() - 90 * 24 * 60 * 60 * 1000);
                    toDate = new Date(now);
                    break;
                    
                case 'thisyear':
                    fromDate = new Date(now.getFullYear(), 0, 1);
                    toDate = new Date(now);
                    break;
                    
                default:
                    return;
            }
            
            // Update the date inputs
            document.getElementById('fromDate').value = fromDate.toISOString().split('T')[0];
            document.getElementById('toDate').value = toDate.toISOString().split('T')[0];
            
            // Update the display and reload data
            updateTimePeriodIndicator();
            loadPaymentSummary();
            loadPaymentData();
        }

        function updateActivePresetButton(activePeriod) {
            // Remove active class from all buttons
            document.querySelectorAll('.period-preset-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Add active class to the selected button
            if (activePeriod) {
                const activeBtn = document.querySelector(`[data-period="${activePeriod}"]`);
                if (activeBtn) {
                    activeBtn.classList.add('active');
                }
            }
        }

        function updateTimePeriodIndicator() {
            const fromDate = document.getElementById('fromDate').value;
            const toDate = document.getElementById('toDate').value;
            
            if (fromDate && toDate) {
                const fromFormatted = new Date(fromDate).toLocaleDateString('en-IN', {
                    day: 'numeric',
                    month: 'short',
                    year: 'numeric'
                });
                const toFormatted = new Date(toDate).toLocaleDateString('en-IN', {
                    day: 'numeric',
                    month: 'short',
                    year: 'numeric'
                });
                
                document.getElementById('currentDateRange').textContent = `${fromFormatted} to ${toFormatted}`;
            } else {
                document.getElementById('currentDateRange').textContent = 'Select date range';
            }
            
            // Update last updated time
            const now = new Date();
            const timeString = now.toLocaleTimeString('en-IN', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            document.getElementById('lastUpdated').textContent = `${timeString}`;
        }

        let settlementHistoryData = [];
        let currentSettlementPage = 0;
        const settlementsPerPage = 20;

        async function viewSettlementHistory() {
            try {
                console.log('Loading settlement history...');
                
                // Show loading state
                document.getElementById('viewSettlementHistoryBtn').innerHTML = '‚è≥ Loading...';
                document.getElementById('viewSettlementHistoryBtn').disabled = true;
                
                const response = await fetch(`${API}/razorpay-reports/all-settlements`, {
                    headers: {
                        'Authorization': 'Bearer ' + localStorage.getItem('token')
                    }
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
                
                const data = await response.json();
                
                if (data.success) {
                    settlementHistoryData = data.settlements.items || [];
                    
                    // Sort by date (newest first)
                    settlementHistoryData.sort((a, b) => b.created_at - a.created_at);
                    
                    // Show settlement history section
                    document.getElementById('settlementHistorySection').style.display = 'block';
                    
                    // Display first page
                    currentSettlementPage = 0;
                    displaySettlementHistory();
                    
                    alert(`‚úÖ Settlement History Loaded!\n\nTotal Settlements: ${settlementHistoryData.length}\n\nScroll down to view the detailed settlement history table.`);
                    
                    // Scroll to settlement history
                    document.getElementById('settlementHistorySection').scrollIntoView({ behavior: 'smooth' });
                    
                } else {
                    throw new Error(data.error || 'Failed to fetch settlement history');
                }
                
            } catch (error) {
                console.error('Error loading settlement history:', error);
                alert(`‚ùå Error loading settlement history!\n\nError: ${error.message}`);
            } finally {
                // Reset button state
                document.getElementById('viewSettlementHistoryBtn').innerHTML = 'üìã View Settlement History';
                document.getElementById('viewSettlementHistoryBtn').disabled = false;
            }
        }

        function displaySettlementHistory() {
            const tbody = document.getElementById('settlementHistoryBody');
            tbody.innerHTML = '';
            
            if (settlementHistoryData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 40px; color: #666;">
                            No settlement history found
                        </td>
                    </tr>
                `;
                return;
            }
            
            const startIndex = currentSettlementPage * settlementsPerPage;
            const endIndex = startIndex + settlementsPerPage;
            const pageData = settlementHistoryData.slice(startIndex, endIndex);
            
            pageData.forEach(settlement => {
                const row = document.createElement('tr');
                
                const settlementDate = new Date(settlement.created_at * 1000).toLocaleDateString('en-IN');
                const amount = (settlement.amount / 100).toFixed(2);
                const fees = (settlement.fees / 100).toFixed(2);
                const tax = (settlement.tax / 100).toFixed(2);
                const netAmount = (parseFloat(amount) - parseFloat(fees) - parseFloat(tax)).toFixed(2);
                
                row.innerHTML = `
                    <td><strong>${settlementDate}</strong></td>
                    <td><code style="font-size: 11px;">${settlement.id}</code></td>
                    <td><strong style="color: #28a745;">‚Çπ${parseFloat(amount).toLocaleString()}</strong></td>
                    <td><span style="color: #dc3545;">‚Çπ${parseFloat(fees).toLocaleString()}</span></td>
                    <td><span style="color: #ffc107;">‚Çπ${parseFloat(tax).toLocaleString()}</span></td>
                    <td><strong style="color: #17a2b8;">‚Çπ${parseFloat(netAmount).toLocaleString()}</strong></td>
                    <td><code style="font-size: 11px;">${settlement.utr || 'N/A'}</code></td>
                    <td><span class="status-badge status-${settlement.status}">${settlement.status}</span></td>
                `;
                
                tbody.appendChild(row);
            });
            
            // Update pagination
            updateSettlementPagination();
        }

        function updateSettlementPagination() {
            const totalPages = Math.ceil(settlementHistoryData.length / settlementsPerPage);
            
            document.getElementById('settlementPageInfo').textContent = `Page ${currentSettlementPage + 1} of ${totalPages}`;
            document.getElementById('prevSettlementBtn').disabled = currentSettlementPage === 0;
            document.getElementById('nextSettlementBtn').disabled = currentSettlementPage >= totalPages - 1;
            
            if (totalPages > 1) {
                document.getElementById('settlementPagination').style.display = 'flex';
            } else {
                document.getElementById('settlementPagination').style.display = 'none';
            }
        }

        function loadPreviousSettlements() {
            if (currentSettlementPage > 0) {
                currentSettlementPage--;
                displaySettlementHistory();
            }
        }

        function loadNextSettlements() {
            const totalPages = Math.ceil(settlementHistoryData.length / settlementsPerPage);
            if (currentSettlementPage < totalPages - 1) {
                currentSettlementPage++;
                displaySettlementHistory();
            }
        }

        function hideSettlementHistory() {
            document.getElementById('settlementHistorySection').style.display = 'none';
        }

        async function exportSettlementHistory() {
            try {
                if (settlementHistoryData.length === 0) {
                    alert('No settlement data to export. Please load settlement history first.');
                    return;
                }
                
                // Generate CSV content
                const csvHeaders = [
                    'Settlement Date',
                    'Settlement ID',
                    'Amount Settled (‚Çπ)',
                    'Fees Deducted (‚Çπ)',
                    'Tax (‚Çπ)',
                    'Net Amount (‚Çπ)',
                    'UTR Number',
                    'Status'
                ];
                
                const csvRows = settlementHistoryData.map(settlement => {
                    const settlementDate = new Date(settlement.created_at * 1000).toLocaleDateString('en-IN');
                    const amount = (settlement.amount / 100).toFixed(2);
                    const fees = (settlement.fees / 100).toFixed(2);
                    const tax = (settlement.tax / 100).toFixed(2);
                    const netAmount = (parseFloat(amount) - parseFloat(fees) - parseFloat(tax)).toFixed(2);
                    
                    return [
                        settlementDate,
                        settlement.id,
                        amount,
                        fees,
                        tax,
                        netAmount,
                        settlement.utr || 'N/A',
                        settlement.status
                    ];
                });
                
                const csvContent = [
                    csvHeaders.join(','),
                    ...csvRows.map(row => row.map(field => `"${field}"`).join(','))
                ].join('\n');
                
                // Download CSV
                const blob = new Blob([csvContent], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `settlement-history-${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                alert(`‚úÖ Settlement history exported!\n\nFile: settlement-history-${new Date().toISOString().split('T')[0]}.csv\nRecords: ${settlementHistoryData.length}`);
                
            } catch (error) {
                console.error('Export error:', error);
                alert('Export failed. Please try again.');
            }
        }

        async function fetchAllRefunds() {
            try {
                console.log('Fetching ALL refunds from Razorpay...');
                
                // Show loading state
                document.getElementById('fetchAllRefundsBtn').innerHTML = '‚è≥ Loading...';
                document.getElementById('fetchAllRefundsBtn').disabled = true;
                
                const response = await fetch(`${API}/razorpay-reports/all-refunds`, {
                    headers: {
                        'Authorization': 'Bearer ' + localStorage.getItem('token')
                    }
                });
                
                console.log('All refunds response status:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('All refunds response error:', errorText);
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
                
                const data = await response.json();
                console.log('All refunds data:', data);
                
                if (data.success) {
                    const refunds = data.refunds;
                    
                    // Update refund cards with comprehensive data
                    document.getElementById('totalRefundAmount').textContent = `‚Çπ${refunds.total.amount.toLocaleString()}`;
                    document.getElementById('processedRefundAmount').textContent = `‚Çπ${refunds.processed.amount.toLocaleString()}`;
                    document.getElementById('pendingRefundAmount').textContent = `‚Çπ${refunds.pending.amount.toLocaleString()}`;
                    document.getElementById('failedRefundAmount').textContent = `‚Çπ${refunds.failed.amount.toLocaleString()}`;
                    
                    // Update card labels with counts
                    const totalRefundCard = document.getElementById('totalRefundAmount').parentElement.parentElement;
                    const totalRefundLabel = totalRefundCard.querySelector('.stat-label');
                    totalRefundLabel.innerHTML = `Total Refunds (ALL TIME)<br><small style="opacity: 0.8;">${refunds.total.count} total refunds</small>`;
                    
                    const processedRefundCard = document.getElementById('processedRefundAmount').parentElement.parentElement;
                    const processedRefundLabel = processedRefundCard.querySelector('.stat-label');
                    processedRefundLabel.innerHTML = `Processed Refunds<br><small style="opacity: 0.8;">${refunds.processed.count} completed</small>`;
                    
                    const pendingRefundCard = document.getElementById('pendingRefundAmount').parentElement.parentElement;
                    const pendingRefundLabel = pendingRefundCard.querySelector('.stat-label');
                    if (refunds.pending.count > 0) {
                        pendingRefundLabel.innerHTML = `Pending Refunds<br><small style="opacity: 0.8; color: #ff6b35; font-weight: 600;">${refunds.pending.count} being processed!</small>`;
                    } else {
                        pendingRefundLabel.innerHTML = `Pending Refunds<br><small style="opacity: 0.8;">No pending refunds</small>`;
                    }
                    
                    const failedRefundCard = document.getElementById('failedRefundAmount').parentElement.parentElement;
                    const failedRefundLabel = failedRefundCard.querySelector('.stat-label');
                    failedRefundLabel.innerHTML = `Failed Refunds<br><small style="opacity: 0.8;">${refunds.failed.count} failed attempts</small>`;
                    
                    // Show detailed alert with refund breakdown
                    let alertMessage = `‚úÖ ALL Refunds Loaded!\n\n`;
                    alertMessage += `üìä REFUND SUMMARY:\n`;
                    alertMessage += `‚Ä¢ Total Refunds: ${refunds.total.count} (‚Çπ${refunds.total.amount.toLocaleString()})\n`;
                    alertMessage += `‚Ä¢ ‚úÖ Processed: ${refunds.processed.count} (‚Çπ${refunds.processed.amount.toLocaleString()})\n`;
                    
                    if (refunds.pending.count > 0) {
                        alertMessage += `‚Ä¢ ‚è≥ PENDING: ${refunds.pending.count} (‚Çπ${refunds.pending.amount.toLocaleString()}) - Being processed!\n`;
                    } else {
                        alertMessage += `‚Ä¢ ‚è≥ Pending: None\n`;
                    }
                    
                    if (refunds.failed.count > 0) {
                        alertMessage += `‚Ä¢ ‚ùå Failed: ${refunds.failed.count} (‚Çπ${refunds.failed.amount.toLocaleString()})\n`;
                    } else {
                        alertMessage += `‚Ä¢ ‚ùå Failed: None\n`;
                    }
                    
                    alertMessage += `\nüí° Pending refunds are money being returned to customers!`;
                    
                    alert(alertMessage);
                    
                } else {
                    console.error('API returned success: false', data);
                    throw new Error(data.error || 'Failed to fetch all refunds');
                }
                
            } catch (error) {
                console.error('Error fetching all refunds:', error);
                alert(`‚ùå Error fetching all refunds!\n\nError: ${error.message}\n\nThis might be normal if your account doesn't have refund API access.`);
            } finally {
                // Reset button state
                document.getElementById('fetchAllRefundsBtn').innerHTML = 'üí∏ Get ALL Refunds';
                document.getElementById('fetchAllRefundsBtn').disabled = false;
            }
        }

        async function fetchAllSettlements() {
            try {
                console.log('Fetching ALL settlements from Razorpay...');
                
                // Show loading state
                document.getElementById('fetchAllSettlementsBtn').innerHTML = '‚è≥ Loading...';
                document.getElementById('fetchAllSettlementsBtn').disabled = true;
                
                const response = await fetch(`${API}/razorpay-reports/all-settlements`, {
                    headers: {
                        'Authorization': 'Bearer ' + localStorage.getItem('token')
                    }
                });
                
                console.log('All settlements response status:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('All settlements response error:', errorText);
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
                
                const data = await response.json();
                console.log('All settlements data:', data);
                
                if (data.success) {
                    const settlements = data.settlements;
                    
                    // Update settlement cards with ALL settlement data
                    document.getElementById('settledAmount').textContent = `‚Çπ${settlements.totalAmount.toLocaleString()}`;
                    document.getElementById('feesAmount').textContent = `‚Çπ${settlements.totalFees.toLocaleString()}`;
                    
                    // Update settlement breakdown with comprehensive data
                    const totalFeesAndTax = settlements.totalFees + settlements.totalTax;
                    const netSettlement = settlements.totalAmount;
                    
                    document.getElementById('netSettlement').textContent = `‚Çπ${netSettlement.toLocaleString()}`;
                    document.getElementById('totalFees').textContent = `‚Çπ${totalFeesAndTax.toLocaleString()}`;
                    
                    // Get current captured amount for percentage calculations
                    const capturedAmountText = document.getElementById('capturedAmount').textContent;
                    const capturedAmount = parseFloat(capturedAmountText.replace('‚Çπ', '').replace(/,/g, '')) || 0;
                    
                    // Calculate percentages based on ALL settlements vs current period payments
                    if (capturedAmount > 0) {
                        const settlementRate = ((netSettlement / capturedAmount) * 100).toFixed(2);
                        const feePercentage = ((totalFeesAndTax / capturedAmount) * 100).toFixed(2);
                        
                        document.getElementById('settlementRate').textContent = `${settlementRate}%`;
                        document.getElementById('feePercentage').textContent = `${feePercentage}%`;
                    }
                    
                    // Update settlement card info
                    const settledCard = document.getElementById('settledAmount').parentElement.parentElement;
                    const settledLabel = settledCard.querySelector('.stat-label');
                    settledLabel.innerHTML = `Settled to Bank (ALL TIME)<br><small style="opacity: 0.8;">${settlements.count} total settlements</small>`;
                    
                    // Update fees card info
                    const feesCard = document.getElementById('feesAmount').parentElement.parentElement;
                    const feesLabel = feesCard.querySelector('.stat-label');
                    feesLabel.innerHTML = `Razorpay Fees (ALL TIME)<br><small style="opacity: 0.8;">+‚Çπ${settlements.totalTax.toLocaleString()} tax</small>`;
                    
                    alert(`‚úÖ ALL Settlements Loaded!\n\nTotal Settlements: ${settlements.count}\nTotal Settled: ‚Çπ${settlements.totalAmount.toLocaleString()}\nTotal Fees: ‚Çπ${totalFeesAndTax.toLocaleString()}\n\nThis shows your complete settlement history!`);
                    
                } else {
                    console.error('API returned success: false', data);
                    throw new Error(data.error || 'Failed to fetch all settlements');
                }
                
            } catch (error) {
                console.error('Error fetching all settlements:', error);
                alert(`‚ùå Error fetching all settlements!\n\nError: ${error.message}\n\nThis might be normal if your account doesn't have settlement API access.`);
            } finally {
                // Reset button state
                document.getElementById('fetchAllSettlementsBtn').innerHTML = 'üìä Get ALL Settlements';
                document.getElementById('fetchAllSettlementsBtn').disabled = false;
            }
        }

        async function testConnection() {
            try {
                console.log('Testing connection to:', `${API}/razorpay-reports/test`);
                console.log('API variable:', API);
                console.log('Token:', localStorage.getItem('token') ? 'Present' : 'Missing');
                
                const response = await fetch(`${API}/razorpay-reports/test`, {
                    headers: {
                        'Authorization': 'Bearer ' + localStorage.getItem('token')
                    }
                });
                
                console.log('Test response status:', response.status);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('Test response data:', data);
                    alert(`‚úÖ Connection successful!\n\nMessage: ${data.message}\nTime: ${data.timestamp}`);
                } else {
                    const errorText = await response.text();
                    console.error('Test response error:', errorText);
                    alert(`‚ùå Connection failed!\n\nStatus: ${response.status}\nError: ${errorText}`);
                }
            } catch (error) {
                console.error('Test connection error:', error);
                alert(`‚ùå Connection error!\n\nError: ${error.message}`);
            }
        }

        async function loadPaymentSummary() {
            try {
                const fromDate = document.getElementById('fromDate').value;
                const toDate = document.getElementById('toDate').value;
                
                console.log('Loading payment summary with API:', API);
                console.log('Date range:', fromDate, 'to', toDate);
                console.log('Token:', localStorage.getItem('token') ? 'Present' : 'Missing');
                
                const url = `${API}/razorpay-reports/summary?from=${fromDate}&to=${toDate}`;
                console.log('Request URL:', url);
                
                const response = await fetch(url, {
                    headers: {
                        'Authorization': 'Bearer ' + localStorage.getItem('token')
                    }
                });
                
                console.log('Response status:', response.status);
                console.log('Response headers:', response.headers);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Response error:', errorText);
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
                
                const data = await response.json();
                console.log('Response data:', data);
                
                if (data.success) {
                    const summary = data.summary;
                    
                    // Safely access nested properties with fallbacks
                    const totalAmount = summary.total?.amount || 0;
                    const capturedAmount = summary.captured?.amount || 0;
                    const settledAmount = summary.settled?.amount || 0;
                    const failedAmount = summary.failed?.amount || 0;
                    const refundedAmount = summary.refunded?.amount || 0;
                    const feesAmount = summary.settled?.fees || 0;
                    const taxAmount = summary.settled?.tax || 0;
                    const settlementCount = summary.settled?.count || 0;
                    
                    console.log('Summary data:', {
                        totalAmount,
                        capturedAmount,
                        settledAmount,
                        failedAmount,
                        refundedAmount,
                        feesAmount,
                        taxAmount,
                        settlementCount
                    });
                    
                    document.getElementById('totalAmount').textContent = `‚Çπ${totalAmount.toLocaleString()}`;
                    document.getElementById('capturedAmount').textContent = `‚Çπ${capturedAmount.toLocaleString()}`;
                    document.getElementById('settledAmount').textContent = `‚Çπ${settledAmount.toLocaleString()}`;
                    document.getElementById('failedAmount').textContent = `‚Çπ${failedAmount.toLocaleString()}`;
                    document.getElementById('refundedAmount').textContent = `‚Çπ${refundedAmount.toLocaleString()}`;
                    document.getElementById('feesAmount').textContent = `‚Çπ${feesAmount.toLocaleString()}`;
                    
                    // Update settlement breakdown
                    const totalFeesAndTax = feesAmount + taxAmount;
                    const netSettlement = settledAmount;
                    const grossAmount = capturedAmount;
                    
                    document.getElementById('netSettlement').textContent = `‚Çπ${netSettlement.toLocaleString()}`;
                    document.getElementById('totalFees').textContent = `‚Çπ${totalFeesAndTax.toLocaleString()}`;
                    
                    // Calculate percentages
                    if (grossAmount > 0) {
                        const settlementRate = ((netSettlement / grossAmount) * 100).toFixed(2);
                        const feePercentage = ((totalFeesAndTax / grossAmount) * 100).toFixed(2);
                        
                        document.getElementById('settlementRate').textContent = `${settlementRate}%`;
                        document.getElementById('feePercentage').textContent = `${feePercentage}%`;
                    } else {
                        document.getElementById('settlementRate').textContent = '0%';
                        document.getElementById('feePercentage').textContent = '0%';
                    }
                    
                    // Add settlement info to the settled card
                    const settledCard = document.getElementById('settledAmount').parentElement.parentElement;
                    const settledLabel = settledCard.querySelector('.stat-label');
                    if (settlementCount > 0) {
                        settledLabel.innerHTML = `Settled to Bank<br><small style="opacity: 0.8;">${settlementCount} settlements</small>`;
                    } else {
                        settledLabel.innerHTML = `Settled to Bank<br><small style="opacity: 0.8;">No settlements yet</small>`;
                    }
                    
                    // Add fees info to the fees card
                    const feesCard = document.getElementById('feesAmount').parentElement.parentElement;
                    const feesLabel = feesCard.querySelector('.stat-label');
                    if (taxAmount > 0) {
                        feesLabel.innerHTML = `Razorpay Fees<br><small style="opacity: 0.8;">+‚Çπ${taxAmount.toLocaleString()} tax</small>`;
                    } else {
                        feesLabel.innerHTML = `Razorpay Fees<br><small style="opacity: 0.8;">Processing fees</small>`;
                    }
                } else {
                    console.error('API returned success: false', data);
                    throw new Error(data.error || 'API returned success: false');
                }
            } catch (error) {
                console.error('Error loading payment summary:', error);
                // Show user-friendly error
                document.getElementById('totalAmount').textContent = 'Error';
                document.getElementById('capturedAmount').textContent = 'Error';
                document.getElementById('settledAmount').textContent = 'Error';
                document.getElementById('failedAmount').textContent = 'Error';
                document.getElementById('refundedAmount').textContent = 'Error';
                document.getElementById('feesAmount').textContent = 'Error';
                document.getElementById('netSettlement').textContent = 'Error';
                document.getElementById('totalFees').textContent = 'Error';
                document.getElementById('settlementRate').textContent = 'Error';
                document.getElementById('feePercentage').textContent = 'Error';
            }
        }

        async function loadPaymentData() {
            const fromDate = document.getElementById('fromDate').value;
            const toDate = document.getElementById('toDate').value;
            const status = document.getElementById('statusFilter').value;
            const count = document.getElementById('countFilter').value;
            
            currentFilters = { fromDate, toDate, status, count };
            currentPage = 0;
            
            await fetchPayments();
        }

        async function fetchPayments() {
            try {
                document.getElementById('loadingState').style.display = 'block';
                document.getElementById('paymentsContainer').style.display = 'none';
                document.getElementById('emptyState').style.display = 'none';
                
                const { fromDate, toDate, status, count } = currentFilters;
                const skip = currentPage * parseInt(count);
                
                const params = new URLSearchParams({
                    from: fromDate,
                    to: toDate,
                    status: status,
                    count: count,
                    skip: skip
                });
                
                const url = `${API}/razorpay-reports/payments?${params}`;
                console.log('Fetching payments from:', url);
                console.log('Token:', localStorage.getItem('token') ? 'Present' : 'Missing');
                
                const response = await fetch(url, {
                    headers: {
                        'Authorization': 'Bearer ' + localStorage.getItem('token')
                    }
                });
                
                console.log('Payments response status:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Payments response error:', errorText);
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
                
                const data = await response.json();
                console.log('Payments data:', data);
                
                document.getElementById('loadingState').style.display = 'none';
                
                if (data.success && data.payments.length > 0) {
                    displayPayments(data.payments);
                    hasMoreData = data.pagination.hasMore;
                    updatePagination();
                    document.getElementById('paymentsContainer').style.display = 'block';
                } else {
                    console.log('No payments found or API error');
                    document.getElementById('emptyState').style.display = 'block';
                }
                
            } catch (error) {
                console.error('Error loading payments:', error);
                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('emptyState').style.display = 'block';
            }
        }

        function displayPayments(payments) {
            const tbody = document.getElementById('paymentsTableBody');
            tbody.innerHTML = '';
            
            payments.forEach(payment => {
                const row = document.createElement('tr');
                
                const statusClass = `status-${payment.status}`;
                const amount = (payment.amount / 100).toFixed(2);
                const createdAt = new Date(payment.created_at * 1000).toLocaleString('en-IN');
                const capturedAt = payment.captured_at ? new Date(payment.captured_at * 1000).toLocaleString('en-IN') : '-';
                
                // User information with fallbacks
                const userName = payment.user_name || 'Unknown User';
                const userEmail = payment.user_email || payment.email || 'No Email';
                const userPhone = payment.user_phone || payment.contact || 'No Phone';
                
                // Add visual indicator if order was found in database
                const orderIndicator = payment.order_found ? '‚úÖ' : '‚ö†Ô∏è';
                const matchMethod = payment.match_method || 'none';
                const orderTitle = payment.order_found ? 
                    `Order found in database (matched by: ${matchMethod})` : 
                    'Order not found in database - may be older payment or webhook issue';
                
                row.innerHTML = `
                    <td><code style="font-size: 11px;">${payment.id}</code></td>
                    <td>
                        <code style="font-size: 11px;">${payment.order_id || '-'}</code>
                        <span title="${orderTitle}" style="margin-left: 5px;">${orderIndicator}</span>
                    </td>
                    <td><strong>‚Çπ${parseFloat(amount).toLocaleString()}</strong></td>
                    <td><span class="status-badge ${statusClass}">${payment.status}</span></td>
                    <td><span class="method-badge">${payment.method || '-'}</span></td>
                    <td><strong style="color: #333;">${userName}</strong></td>
                    <td><a href="mailto:${userEmail}" style="color: #667eea; text-decoration: none;">${userEmail}</a></td>
                    <td><a href="tel:${userPhone}" style="color: #28a745; text-decoration: none;">${userPhone}</a></td>
                    <td>${createdAt}</td>
                    <td>${capturedAt}</td>
                `;
                
                tbody.appendChild(row);
            });
        }

        function updatePagination() {
            document.getElementById('pageInfo').textContent = `Page ${currentPage + 1}`;
            document.getElementById('prevBtn').disabled = currentPage === 0;
            document.getElementById('nextBtn').disabled = !hasMoreData;
        }

        function loadPreviousPage() {
            if (currentPage > 0) {
                currentPage--;
                fetchPayments();
            }
        }

        function loadNextPage() {
            if (hasMoreData) {
                currentPage++;
                fetchPayments();
            }
        }

        async function exportPaymentData() {
            try {
                const fromDate = document.getElementById('fromDate').value;
                const toDate = document.getElementById('toDate').value;
                const status = document.getElementById('statusFilter').value;
                
                if (!fromDate || !toDate) {
                    alert('Please select both from and to dates for export');
                    return;
                }
                
                const params = new URLSearchParams({
                    from: fromDate,
                    to: toDate,
                    status: status
                });
                
                const response = await fetch(`${API}/razorpay-reports/export?${params}`, {
                    headers: {
                        'Authorization': 'Bearer ' + localStorage.getItem('token')
                    }
                });
                
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `razorpay-payments-${fromDate}-to-${toDate}.csv`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                } else {
                    alert('Export failed. Please try again.');
                }
                
            } catch (error) {
                console.error('Export error:', error);
                alert('Export failed. Please try again.');
            }
        }

        // Logout functionality
        document.getElementById("logoutBtn")?.addEventListener("click", () => {
            localStorage.removeItem("token");
            localStorage.removeItem("user");
            window.location.href = "/login.html";
        });
    </script>
</body>
</html>